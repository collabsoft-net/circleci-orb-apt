description: >
  Atlassian Data Center App Performance Toolkit scalability test (run 3, 4 & 5)
  This provisions the environment, runs the test, terminates the environment
  and stores the results to the workspace and as build artifacts

parameters:
  run:
    type: enum
    enum: ["3", "4", "5"]
  product:
    type: enum
    enum: ["jira", "confluence", "bitbucket", "bamboo"]
  version:
    type: string
    default: ""
  environment:
    type: string
  license:
    type: string
    default: ""
  appKey:
    type: string
    default: ""
  archive:
    type: string
    default: ""
  restart_after_install:
    type: boolean
    default: false
  extension_file:
    type: string
    default: ""
  locust_file:
    type: string
    default: ""
  jmx_file:
    type: string
    default: ""
  post_provision_script:
    type: string
    default: ""
  post_provision_script_args:
    type: string
    default: ""

steps:
  - run:
      name: Install NodeJS
      command: <<include(scripts/install-node.sh)>>

  - run:
      name: Install browser support
      command: <<include(scripts/add-browsers.sh)>>

  - run:
      name: Provision environment
      environment:
        PRODUCT: << parameters.product >>
        VERSION: << parameters.version >>
        ENVIRONMENT: << parameters.environment >>-run-<< parameters.run >>
        LICENSE: << parameters.license >>
        POST_PROVISION_SCRIPT: << parameters.post_provision_script >>
        POST_PROVISION_SCRIPT_ARGS: << parameters.post_provision_script_args >>
      command: <<include(scripts/provision.sh)>>
      no_output_timeout: 60m
      when: always

  - run:
      name: Run scalability Test
      environment:
        RUN: run<< parameters.run >>
        PRODUCT: << parameters.product >>
        VERSION: << parameters.version >>
        ENVIRONMENT: << parameters.environment >>-run-<< parameters.run >>
        LICENSE: << parameters.license >>
        APPKEY: << parameters.appKey >>
        ARCHIVE: << parameters.archive >>
        RESTART_AFTER_INSTALL: << parameters.restart_after_install >>
        EXTENSION_FILE: << parameters.extension_file >>
        LOCUST_FILE: << parameters.locust_file >>
        JMX_FILE: << parameters.jmx_file >>
      command: <<include(scripts/scalability.sh)>>
      no_output_timeout: 90m

  - run:
      name: Teardown environment
      environment:
        PRODUCT: << parameters.product >>
        VERSION: << parameters.version >>
        ENVIRONMENT: << parameters.environment >>-run-<< parameters.run >>
      command: <<include(scripts/teardown.sh)>>
      no_output_timeout: 60m
      when: always

  - persist_to_workspace:
      root: /tmp/results
      paths:
        - run<< parameters.run >>

  - store_artifacts:
      path: /tmp/results
